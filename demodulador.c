/*******************************************************************************
  @file     demodulador.c
  @brief    demodulador fsk
  @author   GRUPO 2
 ******************************************************************************/

/*******************************************************************************
 * INCLUDE HEADER FILES
 ******************************************************************************/

#include "demodulador.h"

/*******************************************************************************
 * CONSTANT AND MACRO DEFINITIONS USING #DEFINE
 ******************************************************************************/

/*******************************************************************************
 * ENUMERATIONS AND STRUCTURES AND TYPEDEFS
 ******************************************************************************/

/*******************************************************************************
 * VARIABLES WITH GLOBAL SCOPE
 ******************************************************************************/

/*******************************************************************************
 * FUNCTION PROTOTYPES FOR PRIVATE FUNCTIONS WITH FILE LEVEL SCOPE
 ******************************************************************************/

/*******************************************************************************
 * ROM CONST VARIABLES WITH FILE LEVEL SCOPE
 ******************************************************************************/

/*******************************************************************************
 * STATIC VARIABLES AND CONST VARIABLES WITH FILE LEVEL SCOPE
 ******************************************************************************/

static uint16_t delay;
static double* filtro;
static uint16_t filtSize;
static uint16_t sourceSize;

/*******************************************************************************
 *******************************************************************************
                        GLOBAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/

void demodulador_init(uint32_t fs, float delta, double* filtro_, uint16_t filtSize_, uint16_t* sourceSize_) {
	delay = fs*delta;
	filtro = filtro_;
	filtSize = filtSize_;
	sourceSize = sourceSize_;
}

uint32_t demodulador(uint16_t* bloque, uint16_t j) {

	uint32_t out = 0;
	uint16_t k;
	uint16_t a;
	uint8_t l = filtSize-1;
	for(int i=j; i<j+filtSize; i++) {
		k=i;
		a=k;

		while((k-filtSize)>sourceSize) {
			k -= sourceSize;
		}

		while((a-filtSize-delay)>sourceSize) {
			a -= sourceSize;
		}


		while((k-filtSize)<0) {
			k += sourceSize;
		}

		while((a-filtSize-delay)<0) {
			a += sourceSize;
		}



		out += bloque[a-filtSize-delay]*bloque[k-filtSize]*filtro[l];
		l -= 1;

	}


	return out;
}

/*******************************************************************************
 *******************************************************************************
                        LOCAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/









